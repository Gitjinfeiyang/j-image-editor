"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function easeInExpo(t){return 0===t?0:pow(2,10*t-10)}function easeOutExpo(t){return 1===t?1:1-pow(2,-10*t)}function easeInOutExpo(t){return 0===t?0:1===t?1:t<.5?pow(2,20*t-10)/2:(2-pow(2,-20*t+10))/2}function copyImageData(t){try{return t&&new ImageData(new Uint8ClampedArray(t.data),t.width,t.height)}catch(i){commonCanvas.width=t.width,commonCanvas.height=t.height;var e=commonCanvas.getContext("2d");return e.putImageData(t,0,0),e.getImageData(0,0,t.width,t.height)}}function dataURLToBlob(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],a=atob(e[1]),n=a.length,s=new Uint8Array(n);n--;)s[n]=a.charCodeAt(n);return new Blob([s],{type:i})}function canvasToDataURL(t,e,i){return t.toDataURL(e||"image/jpeg",i||1)}function getShadowImage(t,e){for(var i=copyImageData(t),a=i.data,n=0;n<a.length;n+=4)a[n]-=e,a[n+1]-=e,a[n+2]-=e,a[n]<30&&(a[n]=30),a[n+1]<30&&(a[n+1]=30),a[n+2]<30&&(a[n+2]=30);return i}function windowToCanvas(t,e){return{x:t.x-e.x,y:t.y-e.y}}function type(t){var e=Object.prototype.toString;return t instanceof Element?"element":{"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Uint8ClampedArray]":"array","[object ImageData]":"array","[object Date]":"date","[object RegExp]":"regExp","[object Undefined]":"undefined","[object Null]":"null","[object Object]":"object"}[e.call(t)]}function deepClone(t){var e,i,a,n=type(t);if("array"===n)e=[];else{if("object"!==n)return t;e={}}if("array"===n){for(i=0,a=t.length;i<a;i++)e.push(deepClone(t[i]));return e}if("object"===n){for(i in t)e[i]=deepClone(t[i]);return e}}function isPC(){for(var t=navigator.userAgent,e=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],i=!0,a=0;a<e.length;a++)if(t.indexOf(e[a])>0){i=!1;break}return i}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),pow=Math.pow,sqrt=Math.sqrt,sin=Math.sin,cos=Math.cos,PI=Math.PI,c1=1.70158,c2=1.525*c1,c3=c1+1,c4=2*PI/3,c5=2*PI/4.5,commonCanvas=document.createElement("canvas");commonCanvas.style.display="none";var ImageEditor=function(){function t(e){_classCallCheck(this,t),this.options=e,this.created=this.options.created||function(t){console.log("created")},this.beforeReadFile=this.options.beforeReadFile||function(t){console.log("beforeReadFile")},this.afterReadFile=this.options.afterReadFile||function(t){console.log("afterReadFile")},this.beforeLoadImage=this.options.beforeLoadImage||function(t){console.log("beforeLoadImage")},this.afterLoadImage=this.options.afterLoadImage||function(t){console.log("afterLoadImage")},this.beforeSave=this.options.beforeSave||function(){console.log("beforeSave")},this.afterSave=this.options.afterSave||function(t,e){console.log("afterSave")},this.afterRender=this.options.afterRender||function(){console.log("afterRender")},this.canvas1,this.canvas2,this.shadowImageCanvas=document.createElement("canvas"),this.width=e.width,this.height=e.height,this.animationFrame={},this.center={x:0,y:0},this.editorRect={x:300,y:300,w:e.limit.maxWidth||200,h:e.limit.maxHeight||200},this.imageRect={x:0,y:0,w:0,h:0,centerx:0,centery:0},this.imageTransform={translatex:0,translatey:0,scale:1,scaleCenter:{x:0,y:0,initx:0,inity:0},rotate:0},this.targetTransform={translatex:0,translatey:0,scale:1,scaleCenter:{x:0,y:0,initx:0,inity:0},rotate:0},this.offset={translatex:0,translatey:0,rotate:0,scale:0,scaleCenter:{x:0,y:0,initx:0,inity:0}},this.scaleTime=0,this.rotateTime=0,this.scale=this.initScale=1,this.rotate=this.initRotate=0,this.image,this.shadowImage,this.imageLoaded=!1,this.lineWidth=1,this.controllersContainer,this.container,this.limit={maxHeight:e.limit.maxHeight||0,maxWidth:e.limit.maxWidth||0,minHeight:e.limit.minHeight||0,minWidth:e.limit.minWidth||0,proportion:e.limit.proportion||0,maxSize:e.limit.maxSize||0},this.init()}return _createClass(t,[{key:"init",value:function(){this.createCanvas(),this.createController(),this.initEvent(),this.initImage()}},{key:"initEvent",value:function(){var t=this,e=this.canvas1,i=isPC(),a={x:0,y:0},n=a,s={x:0,y:0},o=!1,r=!1,h=!1,l=!1,c=!1,d=!1,m=!1,f={mousedown:"mousedown",mouseup:"mouseup",mousemove:"mousemove"};if(!i){f={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"};var g=1;new AlloyFinger(this.container,{pinch:function(e){o=!1,h=!1,r=!1,t.transformImage({scaleCenter:{x:(e.touches[0].pageX+e.touches[1].pageX)/2,y:(e.touches[0].pageY+e.touches[1].pageY)/2,scale:0}}),t.scale+=(e.scale-g)*t.scale,g=e.scale},doubleTap:function(e){e.stopPropagation(),e.preventDefault(),o=!1,h=!1,t.transformImage({scaleCenter:{x:e.pageX,y:e.pageY,scale:.2}})},multipointEnd:function(){g=1}})}var u=function(t){return n={x:t.pageX,y:t.pageY},s={x:n.x-a.x,y:n.y-a.y},a=n,s};t.container.addEventListener("mousewheel",function(e){e.stopPropagation(),e.preventDefault();var i=0,a=0;e.wheelDelta?i=e.wheelDelta>0?1:-1:e.detail&&(i=e.detail<0?1:-1),a=i>0?.02:-.02,t.transformImage({scaleCenter:{x:e.pageX,y:e.pageY,scale:a}})}),t.container.addEventListener(f.mousemove,function(e){if(e.preventDefault(),e.stopPropagation(),l){var i=u(e),a={x:i.x,y:i.y,w:-i.x,h:-i.y};t.positingEditor(a)}else if(c){var n=u(e),s={x:n.x,y:0,w:-n.x,h:n.y};t.positingEditor(s)}else if(d){var o=u(e),r={x:0,y:o.y,w:o.x,h:-o.y};t.positingEditor(r)}else if(m){var h=u(e),f={x:0,y:0,w:h.x,h:h.y};t.positingEditor(f)}}),t.container.addEventListener(f.mouseup,function(t){o=!1,r=!1,h=!1,l=!1,c=!1,d=!1,m=!1}),e.addEventListener(f.mousedown,function(t){t.preventDefault(),o=!0,a={x:t.pageX,y:t.pageY}}),e.addEventListener(f.mousemove,function(e){if(e.preventDefault(),o){var i=u(e);t.transformImage({translatex:i.x,translatey:i.y})}}),e.addEventListener(f.mouseup,function(t){t.preventDefault(),o=!1,h=!1}),e.addEventListener("mouseout",function(t){t.preventDefault(),o=!1}),function(){var e=t.container.querySelector("#leftTop"),i=t.container.querySelector("#rightTop"),n=t.container.querySelector("#leftBottom"),s=t.container.querySelector("#rightBottom"),o=t.controllersContainer;o.addEventListener(f.mousedown,function(t){t.preventDefault(),r=!0,h=!0,a={x:t.pageX,y:t.pageY}}),o.addEventListener(f.mousemove,function(e){if(e.preventDefault(),r){var i=u(e);t.positingEditor({x:i.x,y:i.y,w:0,h:0})}}),o.addEventListener(f.mouseout,function(t){t.preventDefault(),r=!1,h=!1}),o.addEventListener("mouseout",function(t){t.preventDefault(),r=!1}),e.addEventListener(f.mousedown,function(t){t.stopPropagation(),l=!0,a={x:t.pageX,y:t.pageY}}),i.addEventListener(f.mousedown,function(t){t.stopPropagation(),d=!0,a={x:t.pageX,y:t.pageY}}),n.addEventListener(f.mousedown,function(t){t.stopPropagation(),c=!0,a={x:t.pageX,y:t.pageY}}),s.addEventListener(f.mousedown,function(t){t.stopPropagation(),m=!0,a={x:t.pageX,y:t.pageY}})}()}},{key:"createCanvas",value:function(){var t=this.canvas1=document.createElement("canvas"),e=this.canvas2=document.createElement("canvas"),i=this.container=document.querySelector(this.options.container);i.appendChild(t),i.appendChild(e),this.refreshCanvasStyle(),this.created(this)}},{key:"refreshCanvasStyle",value:function(){var t=this.canvas1,e=this.canvas2,i=this.container;this.width||(this.width=i.offsetWidth),this.height||(this.height=i.offsetHeight),t.width=e.width=this.width,t.height=e.height=this.height,t.style.zIndex="10",this.center={x:t.width/2,y:t.height/2},this.editorRect.x=this.center.x-this.editorRect.w/2,this.editorRect.y=this.center.y-this.editorRect.h/2,t.style.position="absolute",t.style.top=t.style.left="0",e.style.display="none"}},{key:"createController",value:function(){var t=this.lineWidth,e=this.controllersContainer=document.createElement("div");e.style.position="absolute",e.style.zIndex="100",e.style.background="rgba(0,0,0,0.00001)",e.innerHTML="\n\t\t\t\t\t<div id='leftTop' style='position:absolute; left:-"+6*t+"px; top:-"+6*t+"px; width: 40px; height:40px;border-left:4px solid #fff; border-top:4px solid #fff;'></div>\t\n\t\t\t\t\t<div id='rightTop' style='position:absolute; right:-"+6*t+"px; top:-"+6*t+"px; width: 40px; height:40px;border-right:4px solid #fff; border-top:4px solid #fff;'></div>\t\n\t\t\t\t\t<div id='leftBottom' style='position:absolute; left:-"+6*t+"px; bottom:-"+6*t+"px; width: 40px; height:40px;border-left:4px solid #fff; border-bottom:4px solid #fff;'></div>\t\n\t\t\t\t\t<div id='rightBottom' style='position:absolute; right:-"+6*t+"px; bottom:-"+6*t+"px; width: 40px; height:40px;border-right:4px solid #fff; border-bottom:4px solid #fff;'></div>\t\n\t\t\t",this.container.appendChild(e),this.controllersContainer.style.display="none"}},{key:"initImage",value:function(t,e){var i=this;this.image=new Image,t&&(this.options.imageUrl=t),this.options.imageUrl&&(this.image.onload=function(){e&&e(),i.afterLoadImage(i.image),i.refreshCanvasStyle(),i.startDraw()},this.beforeLoadImage(this.options.imageUrl),this.image.src=this.options.imageUrl,this.clearCanvas())}},{key:"initStage",value:function(t){this.scale=this.initScale=1,this.rotate=this.initRotate=0,this.imageRect={w:this.image.width,h:this.image.height,centerx:this.image.width/2,centery:this.image.height/2},this.shadowImageCanvas.width=this.image.width,this.shadowImageCanvas.height=this.image.height,this.imageFitScreen();var e=this.shadowImageCanvas.getContext("2d");e.drawImage(this.image,0,0);var i=getShadowImage(e.getImageData(0,0,this.image.width,this.image.height),80);e.clearRect(0,0,this.image.width,this.image.height),e.putImageData(i,0,0)}},{key:"imageFitScreen",value:function(){var t=this.width,e=this.height,i=this.image.width,a=this.image.height,n=i/a,s=0,o=0,r=0,h=this.rotate+this.offset.rotate;if(h%180!=0){var l=t;t=e,e=l}n>t/e?(o=t,0,e/2-(s=t/n)/2,h%180!=0&&(e/2-o/2,t/2-s/2),this.initScale=o/i,r=this.initScale-this.scale):(s=e,t/2-(o=n*e)/2,0,h%180!=0&&(e/2-o/2,t/2-s/2),this.initScale=s/a,r=this.initScale-this.scale),this.targetTransform.translatex=0,this.targetTransform.translatey=0,this.targetTransform.scaleCenter={x:0,y:0,initx:0,inity:0},this.scaleInCenter(r)}},{key:"startDraw",value:function(){var t=this,e=this.canvas2.getContext("2d"),i=this.canvas1.getContext("2d");this.initStage(i),this.controllersContainer.style.display="block",this.positingController(this.editorRect),window.cancelAnimationFrame(this.animationFrame);!function a(){t.update(),t.render(i,e),t.animationFrame=window.requestAnimationFrame(a)}(),this.afterRender()}},{key:"clearCanvas",value:function(){this.canvas1.getContext("2d").clearRect(0,0,this.width,this.height),window.cancelAnimationFrame(this.animationFrame)}},{key:"drawEditor",value:function(t,e,i){var a=this.imageTransform,n=this.lineWidth;t.clearRect(0,0,this.width,this.height),t.save(),t.beginPath(),t.moveTo(e.x-n/2,e.y-n/2),t.lineTo(e.x+n/2+i.w,e.y-n/2),t.lineTo(e.x+i.w+n/2,e.y+i.h+n/2),t.lineTo(e.x-n/2,e.y+i.h+n/2),t.closePath(),t.clip(),this.applyTransform(t,a),t.drawImage(this.image,0,0),t.restore(),t.lineWidth=n,t.strokeStyle="#999",t.stroke()}},{key:"positingEditor",value:function(t){var e=this.limit,i=0,a=0,n=0,s=0;i=this.editorRect.x+t.x,n=this.editorRect.w+t.w,a=this.editorRect.y+t.y,s=this.editorRect.h+t.h,0!=e.maxWidth&&n>e.maxWidth?n=e.maxWidth:0!=e.minWidth&&n<e.minWidth?n=e.minWidth:0!=e.minHeight&&s<e.minHeight?s=e.minHeight:0!=e.maxHeight&&s>e.maxHeight?s=e.maxHeight:(this.editorRect.x=i,this.editorRect.y=a,this.editorRect.w=n,this.editorRect.h=s,this.positingController(this.editorRect))}},{key:"positingController",value:function(t){var e=this.controllersContainer;e.style.left=t.x+"px",e.style.top=t.y+"px",e.style.width=t.w+"px",e.style.height=t.h+"px"}},{key:"transformImage",value:function(t){var e=t.translatex||0,i=t.translatey||0,a=t.scaleCenter;if(e&&(this.targetTransform.translatex+=e/this.scale),i&&(this.targetTransform.translatey+=i/this.scale),a){if(a.x!=this.targetTransform.scaleCenter.x&&this.targetTransform.scaleCenter.y!=a.y){var n=this.targetTransform.scaleCenter.x,s=this.targetTransform.scaleCenter.y;this.targetTransform.scaleCenter.x=a.x,this.targetTransform.scaleCenter.y=a.y;var o=this.targetTransform.scaleCenter.initx,r=this.targetTransform.scaleCenter.inity,h=this.scale,l=(this.scale,this.image.width*h),c=this.image.height*h,d=n-(n-o)*h,m=s-(s-r)*h,f=(a.x-d)/l,g=(a.y-m)/c,u=a.x-this.image.width*f,p=a.y-this.image.height*g;this.targetTransform.scaleCenter.initx=u,this.targetTransform.scaleCenter.inity=p}this.scaleTo(a.scale)}}},{key:"applyTransform",value:function(t,e){t.translate(e.scaleCenter.x,e.scaleCenter.y),t.scale(this.scale,this.scale),t.translate(e.scaleCenter.initx-e.scaleCenter.x,e.scaleCenter.inity-e.scaleCenter.y),t.translate(e.translatex,e.translatey),t.translate(this.imageRect.centerx,this.imageRect.centery),t.rotate(this.rotate/180*Math.PI),t.translate(-this.imageRect.centerx,-this.imageRect.centery)}},{key:"scaleTo",value:function(t){t?(this.scaleTime=0,this.initScale=this.scale,this.offset.scale*t<0&&(this.offset.scale=0),this.offset.scale+=t):this.offset.scale=0}},{key:"scaleInCenter",value:function(t){this.scaleTo(),this.targetTransform.scaleCenter.x=this.center.x,this.targetTransform.scaleCenter.y=this.center.y,this.targetTransform.scaleCenter.initx=(this.width-this.image.width)/2,this.targetTransform.scaleCenter.inity=(this.height-this.image.height)/2,this.scaleTo(t)}},{key:"update",value:function(){var t=this.imageTransform,e=this.targetTransform;t.translatex=e.translatex,t.translatey=e.translatey,this.scaleTime<1?(this.scaleTime+=.01,this.scale=easeOutExpo(this.scaleTime)*this.offset.scale+this.initScale,this.scale<.05&&(this.scale=.05,this.scaleTime=1)):(this.offset.scale=0,this.scaleTime=1),this.rotateTime<1?(this.rotateTime+=.01,this.rotate=easeOutExpo(this.rotateTime)*this.offset.rotate+this.initRotate):(this.rotate=this.offset.rotate+this.initRotate,360==this.rotate&&(this.rotate=0),this.offset.rotate=0,this.initRotate=this.rotate,this.rotateTime=1),t.scaleCenter.x=e.scaleCenter.x,t.scaleCenter.y=e.scaleCenter.y,t.scaleCenter.initx=e.scaleCenter.initx,t.scaleCenter.inity=e.scaleCenter.inity}},{key:"render",value:function(t,e){var i=this.imageTransform,a={x:this.editorRect.x,y:this.editorRect.y},n={w:this.editorRect.w,h:this.editorRect.h};t.clearRect(0,0,this.width,this.height),t.save(),this.applyTransform(t,i),t.drawImage(this.shadowImageCanvas,0,0),t.restore(),this.drawEditor(e,a,n),t.drawImage(this.canvas2,0,0),t.font="10px Verdana",t.fillStyle="#fff",t.fillText("当前选中区域： "+parseInt(n.w)+" * "+parseInt(n.h),10,20),t.fillText("缩放： "+parseInt(100*this.scale)+"%",10,40),t.fillText("图片大小： "+this.image.width+"*"+this.image.height,10,60)}},{key:"save",value:function(t){this.beforeSave();var e=this.canvas2.getContext("2d"),i=commonCanvas;i.width=this.editorRect.w,i.height=this.editorRect.h,this.container.appendChild(i);var a=i.getContext("2d"),n=e.getImageData(this.editorRect.x,this.editorRect.y,this.editorRect.w,this.editorRect.h);a.putImageData(n,0,0);var s=i.toDataURL("image/jpeg"),o=dataURLToBlob(s);if(this.limit.maxSize&&this.limit.maxSize<o.size/1024){var r=this.limit.maxSize/(o.size/1024);console.log("压缩前大小："+parseInt(o.size/1024)+"kb"),o=dataURLToBlob(s=i.toDataURL("image/jpeg",r)),console.log("压缩："+parseInt(100*r)+"% 大小："+parseInt(o.size/1024)+"kb")}this.afterSave(s,o),t(s,o)}},{key:"rotateZ",value:function(t){1==this.rotateTime&&(this.offset.rotate=t,this.rotateTime=0,this.imageFitScreen())}},{key:"readFile",value:function(t){var e=this;if(this.beforeReadFile(t),FileReader){var i=new FileReader;i.readAsDataURL(t),i.onload=function(t){e.initImage(t.target.result),e.afterReadFile(t.target.result)}}else{var a=window.URL.createObjectURL(t);this.initImage(a),this.afterReadFile(a)}this.clearCanvas()}}]),t}(),throttle=function(){var t={},e=!1;return function(i){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:17;e||(i(),e=!0,t=setTimeout(function(){e=!1},a))}}();